name: bench

on: [push, pull_request]

jobs:
  benchmark:
    name: Benchmark example analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        SETUP: ['/cvmfs/sw.hsf.org/key4hep/setup.sh', '/cvmfs/sw-nightlies.hsf.org/key4hep/setup.sh']
    steps:
      - uses: actions/checkout@v2
      - uses: cvmfs-contrib/github-action-cvmfs@v2
      - name: Start container
        run: |
          docker run -it --name CI_container -v ${GITHUB_WORKSPACE}:/Package -v /cvmfs:/cvmfs:shared -d ghcr.io/aidasoft/centos7:latest /bin/bash
      - name: CMake Configure
        run: |
          docker exec CI_container /bin/bash -c 'cd Package;\
            mkdir -p build install;\
            source ${{ matrix.SETUP }};\
            cd build;\
            cmake -DCMAKE_INSTALL_PREFIX=../install -DCMAKE_CXX_STANDARD=17  -DCMAKE_CXX_FLAGS=" -fdiagnostics-color=always " -G Ninja ..;'
      - name: Compile
        run: |
          docker exec CI_container /bin/bash -c 'cd ./Package;\
            source ${{ matrix.SETUP }};\
            cd build;\
            ninja -k0;'
      - name: Install
        run: |
          docker exec CI_container /bin/bash -c 'cd ./Package;\
            source ${{ matrix.SETUP }};\
            cd build;\
            ninja -k0 install;'
      - name: Run benchmark
        run: |
          docker exec CI_container /bin/bash -c 'cd ./Package
          source ${{ matrix.SETUP }}
          export PYTHONPATH=$PWD:$PYTHONPATH
          export LD_LIBRARY_PATH=$PWD/install/lib:$LD_LIBRARY_PATH
          export ROOT_INCLUDE_PATH=$PWD/install/include/FCCAnalyses:$ROOT_INCLUDE_PATH
          export LOCAL_DIR=$PWD
          export LD_LIBRARY_PATH=`python -m awkward.config --libdir`:$LD_LIBRARY_PATH
          python config/FCCAnalysisRun.py examples/FCCee/higgs/mH-recoil/mumu/analysis_stage1.py --test --bench'
      - name: Download previous benchmark data
        uses: actions/cache@v1
        with:
          path: ./cache
          key: ${{ matrix.SETUP }}-benchmark
      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'customSmallerIsBetter'
          output-file-path: benchmarks_smaller_better.json
          external-data-json-path: ./cache/benchmark-data.json
          fail-on-alert: true
