<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FCCAnalyses: FCCAnalyses</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="fccanalyses_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FCCAnalyses
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> Common framework for FCC related analyses. This framework allows one to write full analysis, taking <a href="https://github.com/key4hep/EDM4hep">EDM4hep</a> input ROOT files and producing the plots.</p>
<blockquote class="doxtable">
<p>&zwj; As usual, if you aim at contributing to the repository, please fork it, develop your feature/analysis and submit a pull requests.</p>
<p>To have access to the FCC samples, you need to be subscribed to one of the following e-groups (with owner approval) <code>fcc-eos-read-xx</code> with <code>xx=ee,hh,eh</code>. The configuration files are accessible at <code>/afs/cern.ch/work/f/fccsw/public/FCCDicts/</code> with a mirror at <code>/cvmfs/fcc.cern.ch/FCCDicts/</code>. For accessing/reading information about existing datasets you do not need special rights. However, if you need new datasets, you are invited to contact <code>emmanuel.perez@cern.ch</code>, <code>gerardo.ganis@cern.ch</code> or <code>juraj.smiesko@cern.ch</code> who will explian the procedure, including granting the required access, where relevant.</p>
<p></p>
</blockquote>
<p>Detailed code documentation can be found <a href="http://hep-fcc.github.io/FCCAnalyses/doc/latest/index.html">here</a>.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Table of contents</h1>
<ul>
<li>FCCAnalyses<ul>
<li>Table of contents</li>
<li>RootDataFrame based</li>
<li>Getting started</li>
<li>Generalities</li>
<li>Example analysis<ul>
<li>Pre-selection</li>
<li>Final selection</li>
<li>Plotting</li>
</ul>
</li>
<li>Contributing<ul>
<li>Formating</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
RootDataFrame based</h1>
<p>Using ROOT dataframe allows to use modern, high-level interface and very quick processing time as it natively supports multithreading. In this README, everything from reading EDM4hep files on EOS and producing flat n-tuples, to running a final selection and plotting the results will be explained.</p>
<p>ROOT dataframe documentation is available <a href="https://root.cern/doc/master/classROOT_1_1RDataFrame.html">here</a>.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Getting started</h1>
<p>In order to use the FCC analyzers within ROOT RDataFrame, a dictionary needs to be built and put into <code>LD_LIBRARY_PATH</code>. In order to build and load <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> with default options one needs to run following two commands:</p>
<div class="fragment"><div class="line">source ./setup.sh</div>
<div class="line">fccanalysis build</div>
</div><!-- fragment --><p>The <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> is a CMake based project and any customizations can be provided in classic CMake style, the following commands are equivalent to default version of <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a>:</p>
<div class="fragment"><div class="line">source ./setup.sh</div>
<div class="line">mkdir build install</div>
<div class="line">cd build</div>
<div class="line">cmake .. -DCMAKE_INSTALL_PREFIX=../install</div>
<div class="line">make install</div>
<div class="line">cd ..</div>
</div><!-- fragment --><blockquote class="doxtable">
<p>&zwj; Each time changes are made in the C++ code, for example in <code>analyzers/dataframe/</code> please do not forget to re-compile :)</p>
<p>To cleanly recompile the default version of <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> one can use <code>fccanalysis build --clean-build</code>. </p>
</blockquote>
<p>In order to provide the possibility to keep developing an analysis with well defined Key4hep stack, the sub-command <code>fccanalysis pin</code> is provided. One can pin his/her analysis with </p><div class="fragment"><div class="line">source setup.sh</div>
<div class="line">fccanalysis pin</div>
</div><!-- fragment --><p>To remove the pin run </p><div class="fragment"><div class="line">fccanalysis pin --clear</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Generalities</h1>
<p>Analyses in the <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> framework usually follow standardized workflow, which consists of multiple files inside a single directory. Individual files denote steps in the analysis and have the following meaning:</p>
<ol type="1">
<li><code>analysis.py</code> or <code>analysis_stage&lt;num&gt;</code>: In this file(s) the class of type <code>RDFanalysis</code> is used to define the list of analysers and filters to run on (<code>analysers</code> function) as well as the output variables (<code>output</code> function). It also contains the configuration parameters <code>processList</code>, <code>prodTag</code>, <code>outputDir</code>, <code>inputDir</code>, <code>nCPUS</code> and <code>runBatch</code>. User can define multiple stages of <code>analysis.py</code>. The first stage will most likely run on centrally produced EDM4hep events, thus the usage of <code>prodTag</code>. When running a second analysis stage, user points to the directory where the samples are located using <code>inputDir</code>.</li>
<li><code>analysis_final.py</code>: This analysis file contains the final selections and it runs over the locally produced n-tuples from the various stages of <code>analysis.py</code>. It contains a link to the <code>procDict.json</code> such that the samples can be properly normalised by getting centrally produced cross sections. (this might be removed later to include everything in the yaml, closer to the sample). It also contains the list of processes (matching the standard names), the number of CPUs, the cut list, and the variables (that will be both written in a <code>TTree</code> and in the form of <code>TH1</code> properly normalised to an integrated luminosity of 1pb<sup>-1</sup>.</li>
<li><code>analysis_plots.py</code>: This analysis file is used to select the final selections from running <code>analysis_final.py</code> to plot. It usually contains information about how to merge processes, write some extra text, normalise to a given integrated luminosity etc... For the moment it is possible to only plot one signal at the time, but several backgrounds.</li>
</ol>
<h1><a class="anchor" id="autotoc_md5"></a>
Example analysis</h1>
<p>To better explain the <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> workflow let's run our example analysis. The analysis should be located at <code>examples/FCCee/higgs/mH-recoil/mumu/</code>.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Pre-selection</h2>
<p>The pre-selection runs over already existing and properly registered FCCSW EDM4hep events. The dataset names with the corresponding statistics can be found <a href="http://fcc-physics-events.web.cern.ch/fcc-physics-events/FCCee/spring2021/Delphesevents_IDEA.php">here</a> for the IDEA spring 2021 campaign. The <code>processList</code> is a dictionary of processes, each process having it's own dictionary of parameters. For example </p><div class="fragment"><div class="line"><span class="stringliteral">&#39;p8_ee_ZH_ecm240&#39;</span>:{<span class="stringliteral">&#39;fraction&#39;</span>:0.2, <span class="stringliteral">&#39;chunks&#39;</span>:2, <span class="stringliteral">&#39;output&#39;</span>:<span class="stringliteral">&#39;p8_ee_ZH_ecm240_out&#39;</span>}</div>
</div><!-- fragment --><p> where <code>p8_ee_ZH_ecm240</code> should match an existing sample in the database, <code>fraction</code> is the fraction of the sample you want to run on (default is 1), <code>chunks</code> is the number of jobs to run (you will have the corresponding number of output files) and <code>output</code> in case you need to change the name of the output file (please note that then the sample will not be matched in the database for <code>finalSel.py</code> histograms normalisation). The other parameters are explained in <a href="https://github.com/HEP-FCC/FCCAnalyses/blob/master/examples/FCCee/higgs/mH-recoil/mumu/analysis_stage1.py">the example file</a>.</p>
<p>To run the pre-selection stage of the example analysis run:</p>
<div class="fragment"><div class="line">fccanalysis run examples/FCCee/higgs/mH-recoil/mumu/analysis_stage1.py</div>
</div><!-- fragment --><p>This will create the output files in the <code>ZH_mumu_recoil/stage1</code> subdirectory of the output director specified with parameter <code>outDir</code> in the file.</p>
<p>You also have the possibility to bypass the samples specified in the <code>processList</code> variable by using command line parameter <code>--output</code>, like so:</p>
<div class="fragment"><div class="line">fccanalysis run examples/FCCee/higgs/mH-recoil/mumu/analysis_stage1.py \</div>
<div class="line">       --output &lt;myoutput.root&gt; \</div>
<div class="line">       --files-list &lt;file.root or file1.root file2.root or file*.root&gt;</div>
</div><!-- fragment --><p>The example analysis consists of two pre-selection stages, to run the second one slightly alter the previous command:</p>
<div class="fragment"><div class="line">fccanalysis run examples/FCCee/higgs/mH-recoil/mumu/analysis_stage2.py</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
Pre-selection on batch (HTCondor)</h3>
<p>It is also possible to run the pre-selection step on the batch. For that the <code>runBatch</code> parameter needs to be set to true. Please make sure you select a long enough <code>batchQueue</code> and that your computing group is properly set <code>compGroup</code> (as you might not have the right to use the default one <code>group_u_FCC.local_gen</code> as it request to be part of the FCC computing e-group <code>fcc-experiments-comp</code>). When running on batch, you should use the <code>chunk</code> parameter for each sample in your <code>processList</code> such that you benefit from high parallelisation.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Final selection</h2>
<p>The final selection runs on the pre-selection files that were produced in the Pre-selection step. In the configuration file <code>analysis_final.py</code> various cuts are defined to be run on and the final variables to be stored in both a <code>TTree</code> and histograms. This is why the variables needs extra fields like <code>title</code>, number of bins and range for the histogram creation. In the example analysis it can be run like this:</p>
<div class="fragment"><div class="line">fccanalysis final examples/FCCee/higgs/mH-recoil/mumu/analysis_final.py</div>
</div><!-- fragment --><p>This will create 2 files per selection <code>SAMPLENAME_SELECTIONNAME.root</code> for the <code>TTree</code> and <code>SAMPLENAME_SELECTIONNAME_histo.root</code> for the histograms. <code>SAMPLENAME</code> and <code>SELECTIONNAME</code> correspond to the name of the sample and selection respectively in the configuration file.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Plotting</h2>
<p>The plotting analysis file <code>analysis_plots.py</code> contains not only details for the rendering of the plots but also ways of combining samples for plotting. In the example analysis it can be run in the following manner:</p>
<div class="fragment"><div class="line">fccanalysis plots examples/FCCee/higgs/mH-recoil/mumu/analysis_plots.py</div>
</div><!-- fragment --><p>Resulting plots will be located the <code>outdir</code> defined in the analysis file.</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Experimental</h2>
<p>In an attempt to ease the development of new physics case studies, such as for the <a href="https://github.com/HEP-FCC/FCCeePhysicsPerformance">FCCee physics performance</a> cases, a new experimental analysis package creation tool is introduced. See here for more details.</p>
<h1><a class="anchor" id="autotoc_md11"></a>
Contributing</h1>
<h2><a class="anchor" id="autotoc_md12"></a>
Code formating</h2>
<p>The preferred style of the C++ code in the <a class="el" href="namespace_f_c_c_analyses.html" title="Jet clustering utilities interface.">FCCAnalyses</a> is LLVM which is checked by CI job.</p>
<p>Currently <code>clang-format</code> is not available in the Key4hep stack, but one can obtain a suitable version of it from CVMFS thanks to LCG: </p><div class="fragment"><div class="line">source /cvmfs/sft.cern.ch/lcg/contrib/clang/14.0.6/x86_64-centos7/setup.sh</div>
</div><!-- fragment --><p>Then to apply formatting to a given file: </p><div class="fragment"><div class="line">clang-format -i -style=file /path/to/file.cpp</div>
</div><!-- fragment --><p>Another way to obtain a recent version of <code>clang-format</code> is through downloading <a href="https://key4hep.github.io/key4hep-doc/spack-build-instructions-for-librarians/spack-setup.html#downloading-a-spack-instance">Key4hep Spack instance</a>. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Sep 19 2023 11:40:16 for FCCAnalyses by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.9.6
</small></address>
</body>
</html>
